# Raft

### 任务分解
- 领导人选举
- 日志复制
- 安全性
- 角色

### 状态

#### 所有服务器上的持久性状态 
|参数	|解释|
|---|---|
|currentTerm	|服务器已知最新的任期（在服务器首次启动的时候初始化为0，单调递增）|
|votedFor	|当前任期内收到选票的候选者id 如果没有投给任何候选者 则为空|
|log[]	|日志条目;每个条目包含了用于状态机的命令，以及领导者接收到该条目时的任期（第一个索引为1）|

#### 所有服务器上的易失性状态
|参数	|解释|
|---|---|
|commitIndex	|已知已提交的最高的日志条目的索引（初始值为0，单调递增）|
|lastApplied	|已经被应用到状态机的最高的日志条目的索引（初始值为0，单调递增）|

#### 领导者（服务器）上的易失性状态 (选举后已经重新初始化)
|参数	|解释|
|---|---|
|nextIndex[]	|对于每一台服务器，发送到该服务器的下一个日志条目的索引（初始值为领导者最后的日志条目的索引+1）|
|matchIndex[]	|对于每一台服务器，已知的已经复制到该服务器的最高日志条目的索引（初始值为0，单调递增）|

### 追加条目RPC
被领导者调用 用于日志条目的复制 同时也被当做心跳使用
Request:

|参数	|解释|
|---|---|
|term	|领导者的任期|
|leaderId	|领导者ID 因此跟随者可以对客户端进行重定向（译者注：跟随者根据领导者id把客户端的请求重定向到领导者，比如有时客户端把请求发给了跟随者而不是领导者）|
|prevLogIndex	|紧邻新日志条目之前的那个日志条目的索引|
|prevLogTerm	|紧邻新日志条目之前的那个日志条目的任期|
|entries[]	|需要被保存的日志条目（被当做心跳使用是 则日志条目内容为空；为了提高效率可能一次性发送多个）|
|leaderCommit	|领导者的已知已提交的最高的日志条目的索引|

Response:

|参数	|解释|
|---|---|
|term	|当前任期,对于领导者而言 它会更新自己的任期|
|success	|结果为真 如果跟随者所含有的条目和preLogIndex以及preLogTerm匹配上了|
接收者的实现：
1. 返回假 如果领导者的任期 小于 接收者的当前任期（译者注：这里的接收者是指跟随者或者候选者）（5.1 节）
2. 返回假 如果接收者日志中没有包含这样一个条目 即该条目的任期在preLogIndex上能和prevLogTerm匹配上 （译者注：在接收者日志中 如果能找到一个和preLogIndex以及prevLogTerm一样的索引和任期的日志条目 则返回真 否则返回假）（5.3 节）
3. 如果一个已经存在的条目和新条目（译者注：即刚刚接收到的日志条目）发生了冲突（因为索引相同，任期不同），那么就删除这个已经存在的条目以及它之后的所有条目 （5.3 节）
4. 追加日志中尚未存在的任何新条目
5. 如果领导者的已知已经提交的最高的日志条目的索引 大于 接收者的已知已经提交的最高的日志条目的索引 则把 接收者的已知已经提交的最高的日志条目的索引 重置为 领导者的已知已经提交的最高的日志条目的索引 或者是 上一个新条目的索引 取两者的最小值

### 请求投票 RPC：
由候选人负责调用用来征集选票

|参数	|解释|
|---|---|
|term	|候选人的任期号|
|candidateId	|请求选票的候选人的 Id|
|lastLogIndex	|候选人的最后日志条目的索引值|
|lastLogTerm	|候选人最后日志条目的任期号|

|返回值	|解释|
|---|---|
|term	|当前任期号，以便于候选人去更新自己的任期号|
|voteGranted	|候选人赢得了此张选票时为真|
接收者实现：

1. 如果term < currentTerm返回 false （5.2 节）
2. 如果 votedFor 为空或者为 candidateId，并且候选人的日志至少和自己一样新，那么就投票给他（5.2 节，5.4 节）

### 所有服务器需遵守的规则：
所有服务器：

* 如果commitIndex > lastApplied，那么就 lastApplied 加一，并把log[lastApplied]应用到状态机中（5.3 节）
* 如果接收到的 RPC 请求或响应中，任期号T > currentTerm，那么就令 currentTerm 等于 T，并切换状态为跟随者（5.1 节）

跟随者（5.2 节）：

* 响应来自候选人和领导者的请求
* 如果在超过选举超时时间的情况之前没有收到当前领导人（即该领导人的任期需与这个跟随者的当前任期相同）的心跳/附加日志，或者是给某个候选人投了票，就自己变成候选人

候选人（5.2 节）：

* 在转变成候选人后就立即开始选举过程
    * 自增当前的任期号（currentTerm）
    * 给自己投票
    * 重置选举超时计时器
    * 发送请求投票的 RPC 给其他所有服务器
* 如果接收到大多数服务器的选票，那么就变成领导人
* 如果接收到来自新的领导人的附加日志 RPC，转变成跟随者
* 如果选举过程超时，再次发起一轮选举

领导人：

* 一旦成为领导人：发送空的附加日志 RPC（心跳）给其他所有的服务器；在一定的空余时间之后不停的重复发送，以阻止跟随者超时（5.2 节）
* 如果接收到来自客户端的请求：附加条目到本地日志中，在条目被应用到状态机后响应客户端（5.3 节）
* 如果对于一个跟随者，最后日志条目的索引值大于等于 nextIndex，那么：发送从 nextIndex 开始的所有日志条目：
    * 如果成功：更新相应跟随者的 nextIndex 和 matchIndex
    * 如果因为日志不一致而失败，减少 nextIndex 重试
* 如果存在一个满足`N > commitIndex`的 N，并且大多数的`matchIndex[i] ≥ N`成立，并且`log[N].term == currentTerm`成立，那么令 commitIndex 等于这个 N （5.3 和 5.4 节）

|特性	|解释|
|---|---|
|选举安全特性	|对于一个给定的任期号，最多只会有一个领导人被选举出来（5.2 节）|
|领导人只附加原则	|领导人绝对不会删除或者覆盖自己的日志，只会增加（5.3 节）|
|日志匹配原则	|如果两个日志在相同的索引位置的日志条目的任期号相同，那么我们就认为这个日志从头到这个索引位置之间全部完全相同（5.3 节）|
|领导人完全特性	|如果某个日志条目在某个任期号中已经被提交，那么这个条目必然出现在更大任期号的所有领导人中（5.4 节）|
|状态机安全特性	|如果一个领导人已经将给定的索引值位置的日志条目应用到状态机中，那么其他任何的服务器在这个索引位置不会应用一个不同的日志（5.4.3 节）|

